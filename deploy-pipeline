pipeline {
    agent any

    parameters {
        string(name: "App_Name", defaultValue: "datastore-deploy", description: "Kubernetes deployment name")
        string(name: "App_Version", defaultValue: "latest", description: "Docker image version to deploy")
    }

    environment {
        KUBECONFIG = credentials('K8S_CONFIG_SECRET') // Kubernetes config stored as Jenkins Secret
    }

    stages {
        stage('Deploy to Kubernetes') {
            steps {
                script {
                    echo "-------- Starting Deployment --------"

                    sh """
                        kubectl set image deployment/${params.App_Name} mywebapp=abhi9604/datastore:${params.App_Version} --record
                        kubectl rollout status deployment/${params.App_Name} || exit 1
                    """

                    echo "-------- Deployment Completed Successfully --------"
                }
            }
        }
    }
}
